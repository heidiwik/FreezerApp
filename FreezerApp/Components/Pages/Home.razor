@page "/"
@rendermode InteractiveServer

@using FreezerApp.Models
@using FreezerApp.Services

@inject TableService TableService
@inject IConfiguration Configuration
@inject ILogger<Home> Logger

<PageTitle>Freezer app</PageTitle>

<h1>Freezer app</h1>

@if (groupedItems == null)
{
    <p>Loading...</p>
}
else if (groupedItems.Count == 0)
{
    <p>No items found.</p>
}
else
{
    <table class="table table-hover">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th>Quantity</th>
                <th>Box</th>
                <th>Compartment</th>
                <th>Stored</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var group in groupedItems)
            {
                bool canExpand = group.Ids.Count > 1 && group.Boxes.Any(x => !string.IsNullOrWhiteSpace(x));
                <tr class="@(canExpand ? "table-group-row clickable" : "") @(expandedGroups.Contains(group.Name) ? "table-active border-bottom-row" : "")"
                    @onclick="() => { if (canExpand) ToggleGroup(group.Name); }"
                    style=@($"cursor:{(canExpand ? "pointer" : "default")}")>
                    <td>
                        <b>@group.Name </b>
                        @if (canExpand)
                        {
                            <span> <i class="bi @(expandedGroups.Contains(group.Name) ? "bi-caret-up-fill" : "bi-caret-down-fill") bi-icon"></i></span>
                        }
                    </td>
                    <td>@group.TotalQuantity</td>
                    <td>
                        @foreach (var box in group.Boxes)
                        {
                            <span class="badge rounded-pill bg-primary">@box</span>
                        }
                    </td>
                    <td>
                        @foreach (var compartment in group.Locations)
                        {
                            <span class="badge bg-success rounded-pill">@compartment</span>
                        }
                    </td>
                    <td>@group.EarliestStoreDate.ToString("dd.MM.yy H:mm")</td>
                    <td>
                        @if (!canExpand)
                        {
                            <button class="btn btn-danger btn-sm"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ShowConfirm(GetDeleteMessage(group.Name), async () => await DeleteSingle(group.Ids.FirstOrDefault()))">
                                @(group.TotalQuantity > 1 ? "Delete one" : "Delete")
                            </button>
                        }
                    </td>
                </tr>

                @if (expandedGroups.Contains(group.Name))
                {
                    var items = freezerItems!.Where(x => x.Name == group.Name).OrderBy(x => x.StoreDate).ToList();
                    @foreach (var item in items)
                    {
                        <tr class="table-active">
                            <td colspan="1"></td>
                            <td>@(item.Quantity > 1 ? item.Quantity : "")</td>
                            <td>@(item.BoxId?.ToString() ?? "")</td>
                            <td>@(item.Location ?? "")</td>
                            <td>@item.StoreDate.ToString("dd.MM.yy H:mm")</td>
                            <td>
                                <button class="btn btn-danger btn-sm"
                                        @onclick:stopPropagation="true"
                                        @onclick="() => ShowConfirm(GetDeleteMessage(item.Name), async () => await DeleteSingle(item.Id))">
                                    @(item.Quantity > 1 ? "Delete one" : "Delete")
                                </button>
                            </td>
                        </tr>
                    }
                }
            }
        </tbody>
    </table>
}

@if (showConfirm){
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                </div>
                <div class="modal-body">
                    <p>@confirmMessage</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => showConfirm = false">Cancel</button>
                    <button class="btn btn-danger" @onclick="OnConfirm">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<FreezerItem>? freezerItems;
    private List<GroupedItem>? groupedItems;

    private HashSet<string> expandedGroups = new();

    private void ToggleGroup(string groupName)
    {
        if (!expandedGroups.Add(groupName))
            expandedGroups.Remove(groupName);
    }

    private bool showConfirm = false;
    private string? confirmMessage;
    private Func<Task>? confirmAction;

    private void ShowConfirm(string message, Func<Task> action)
    {
        confirmMessage = message;
        confirmAction = action;
        showConfirm = true;
    }

    private async Task OnConfirm()
    {
        showConfirm = false;
        if (confirmAction != null)
            await confirmAction.Invoke();
    }

    protected override async Task OnInitializedAsync()
    {
        freezerItems = await TableService.GetFreezerItemsAsync(Configuration, Logger);

        if (freezerItems == null)
            return;

        GroupItems();
    }

    private string GetDeleteMessage(string name)
    {
        return $"Delete {name}?";

        // return group.TotalQuantity > 1
        //     ? $"Delete first item of '{group.Name}'?"
        //     : $"Delete '{group.Name}'?";
    }

    private void GroupItems()
    {
        groupedItems = freezerItems
            ?.GroupBy(i => i.Name)
            .Select(g => new GroupedItem
                {
                    Name = g.Key,
                    TotalQuantity = g.Sum(x => x.Quantity),
                    Boxes = g.Select(x => x.BoxId?.ToString() ?? "").Distinct().ToList(),
                    Locations = g.Select(x => x.Location ?? "").Distinct().ToList(),
                    EarliestStoreDate = g.Min(x => x.StoreDate),
                    Ids = g.Select(x => x.Id).ToList()
                })
            .OrderBy(g => g.Name)
            .ToList();
    }

    private async Task DeleteFirst(string name)
    {
        if (freezerItems == null) return;
        var firstItem = freezerItems.Where(x => x.Name == name).OrderBy(x => x.StoreDate).FirstOrDefault();
        if (firstItem != null)
        {
            await TableService.DeleteFreezerItemAsync(firstItem.Id, Configuration, Logger);
            freezerItems = await TableService.GetFreezerItemsAsync(Configuration, Logger);
            GroupItems();
            StateHasChanged();
        }
    }

    // if the item has quantity > 1, decrease the quantity by 1
    // else item is single item, delete it
    private async Task DeleteSingle(Guid id)
    {
        var item = freezerItems?.FirstOrDefault(x => x.Id == id);

        if (item != null)
        {
            var deleteSingleRow = item.Quantity == 1;

            if (deleteSingleRow)
            {
                await DeleteFirst(item.Name);
            }
            else
            {
                item.Quantity--;

                await TableService.UpdateFreezerItemAsync(item, Configuration, Logger);

                freezerItems = await TableService.GetFreezerItemsAsync(Configuration, Logger);
                GroupItems();
                StateHasChanged();
            }
        }
    }

    // unused for now
    // private async Task DeleteAll(string name)
    // {
    //     if (freezerItems == null) return;
    //     var itemsToDelete = freezerItems.Where(x => x.Name == name).ToList();
    //     foreach (var item in itemsToDelete)
    //     {
    //         await TableService.DeleteFreezerItemAsync(item.Id, Configuration, Logger);
    //     }
    //     freezerItems = await TableService.GetFreezerItemsAsync(Configuration, Logger);
    //     GroupItems();
    //     StateHasChanged();
    // }


    private class GroupedItem
    {
        public string Name { get; set; } = string.Empty;
        public int TotalQuantity { get; set; }
        public List<string> Boxes { get; set; } = new();
        public List<string> Locations { get; set; } = new();
        public DateTime EarliestStoreDate { get; set; }
        public List<Guid> Ids { get; set; } = new();
    }
}
